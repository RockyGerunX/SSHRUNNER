name: SSH Tunnel Workflow

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  ssh-tunnel:
    runs-on: ubuntu-latest
    steps:
      # Checkout kode repositori
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Setup cache untuk menyimpan data
      - name: Cache Data
        id: cache-data
        uses: actions/cache@v4
        with:
          path: |
            ~/data
            ~/logs
          key: ${{ runner.os }}-data-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-data-

      # Install dependensi
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autossh openssh-server
          # Install cloudflared
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /tmp/cloudflared
          sudo chmod +x /tmp/cloudflared
          sudo mv /tmp/cloudflared /usr/local/bin/cloudflared

      # Setup direktori
      - name: Setup Directories
        run: |
          mkdir -p ~/data ~/logs
          echo "Data directory: ~/data" | tee -a ~/logs/setup.log
          echo "Logs directory: ~/logs" | tee -a ~/logs/setup.log

      # Setup SSH server
      - name: Setup SSH Server
        run: |
          # Konfigurasi SSH server untuk port 2222
          sudo sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config
          sudo systemctl restart ssh
          # Verifikasi port 2222
          sudo ss -tlnp | grep 2222 || { echo "SSH server gagal di port 2222"; exit 1; }
          # Setup kunci SSH
          if [ ! -f ~/.ssh/id_rsa ]; then
            ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa
          fi
          cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
          chmod 600 ~/.ssh/authorized_keys
          # Konfigurasi autossh
          echo "Host tunnel
                HostName localhost
                User runner
                Port 2222
                IdentityFile ~/.ssh/id_rsa
                ServerAliveInterval 30
                ServerAliveCountMax 3
                ExitOnForwardFailure yes" > ~/.ssh/config
          echo "SSH setup completed at $(date)" | tee -a ~/logs/setup.log

      # Start Cloudflare Tunnel
      - name: Start Cloudflare Tunnel
        run: |
          nohup cloudflared tunnel --url ssh://localhost:2222 > ~/logs/cloudflared.log 2>&1 &
          sleep 5
          TUNNEL_URL=$(grep -oP 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' ~/logs/cloudflared.log | head -n 1)
          if [ -z "$TUNNEL_URL" ]; then
            echo "Error: Tidak bisa mendapatkan URL tunnel"
            cat ~/logs/cloudflared.log
            exit 1
          fi
          echo "Tunnel URL: $TUNNEL_URL" | tee -a ~/logs/tunnel.log
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV

      # Start Autossh
      - name: Start Autossh
        run: |
          nohup autossh -M 0 -N -o "ServerAliveInterval=30" -o "ServerAliveCountMax=3" tunnel > ~/logs/autossh.log 2>&1 &
          sleep 2
          if pgrep autossh > /dev/null; then
            echo "Autossh berjalan" | tee -a ~/logs/tunnel.log
          else
            echo "Autossh gagal" | tee -a ~/logs/tunnel.log
            cat ~/logs/autossh.log
            exit 1
          fi

      # Tampilkan informasi tunnel
      - name: Display Tunnel Info
        run: |
          echo "Tunnel aktif di: ${{ env.TUNNEL_URL }}:2222"
          echo "Untuk koneksi SSH, gunakan:"
          echo "ssh -o ProxyCommand='cloudflared access tcp --hostname ${{ env.TUNNEL_URL }}' runner@localhost -p 2222"
          echo "Log Cloudflare Tunnel:" | tee -a ~/logs/tunnel.log
          cat ~/logs/cloudflared.log | tee -a ~/logs/tunnel.log
          echo "Log Autossh:" | tee -a ~/logs/tunnel.log
          cat ~/logs/autossh.log | tee -a ~/logs/tunnel.log

      # Keep alive 6 jam
      - name: Keep Alive for 6 Hours
        run: |
          END_TIME=$(( $(date +%s) + 6*60*60 ))
          while [ $(date +%s) -lt $END_TIME ]; do
            echo "Keep alive: $(date)" | tee -a ~/logs/keep-alive.log
            echo "Tunnel: ${{ env.TUNNEL_URL }}:2222" | tee -a ~/logs/keep-alive.log
            if pgrep autossh > /dev/null; then
              echo "Autossh aktif" | tee -a ~/logs/keep-alive.log
            else
              echo "Autossh mati, restart..." | tee -a ~/logs/keep-alive.log
              nohup autossh -M 0 -N -o "ServerAliveInterval=30" -o "ServerAliveCountMax=3" tunnel > ~/logs/autossh.log 2>&1 &
            fi
            sleep 300
          done
          echo "Keep alive selesai" | tee -a ~/logs/keep-alive.log

      # Simpan log akhir
      - name: Save Final Logs
        if: always()
        run: |
          echo "Final Logs at $(date)" | tee -a ~/logs/final.log
          echo "Setup Log:" | tee -a ~/logs/final.log
          cat ~/logs/setup.log | tee -a ~/logs/final.log
          echo "Tunnel Log:" | tee -a ~/logs/final.log
          cat ~/logs/tunnel.log | tee -a ~/logs/final.log
          echo "Keep Alive Log:" | tee -a ~/logs/final.log
          cat ~/logs/keep-alive.log | tee -a ~/logs/final.log
